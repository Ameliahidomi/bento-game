<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»Šå¤©å°±è¦åƒé€™å®¶ ğŸ±</title>
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, "Microsoft JhengHei", sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    #grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .cell {
      background: #111827;
      border: 1px solid rgba(255,255,255,.2);
      padding: 10px;
      border-radius: 10px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
      font-weight: bold;
    }
    .active { background: #60a5fa; color: #fff; }
    .chosen { background: #ef4444; color: #fff; }
    .done { background: #6b7280; color: #ccc; text-decoration: line-through; }
    .btn {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .start { background: #2563eb; color: white; }
    .stop { background: #dc2626; color: white; }
  </style>
</head>
<body>
  <h1>ä»Šå¤©å°±è¦åƒé€™å®¶ ğŸ±</h1>
  <p>å¤šäººåŒæ­¥æŠ½ç±¤ï¼ŒæŒ‰åœæ­¢æœƒå¯„ä¿¡ç´€éŒ„</p>

  <button id="startBtn" class="btn start">é–‹å§‹</button>
  <button id="stopBtn" class="btn stop" disabled>åœæ­¢</button>

  <div id="grid"></div>

  <audio id="bgm" src="https://mega.nz/file/VJQhwSgZ#adetBhp9oqM3CMs-IdnUTsY1C7HIt9BAHmsSusorKlQ" loop></audio>

  <!-- Firebase Modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /***************
     * 1) é¤å»³æ¸…å–®
     ***************/
    const RESTAURANTS = [
      "ä¸€å¤«æ’éª¨","è…ä¹³è±¬","å† å®æ¶¼éºµ","æ—å®¶æ°´é¤ƒ","æ­¦æ‘é¢¨å‘³ä¾¿ç•¶","è­šè€çˆºåŒ—å¹³éºµé£Ÿ","69 PIZZA",
      "å¯¶éº—é»å¿ƒå»šæˆ¿","å’†é£½é£½å‰µæ„é‹ç‡’","é˜¿æ˜‡å»šæˆ¿","å…«å…©äº”éª¨é´¨","åŒæ˜Œå¤§é›è…¿","æœ±éºµå±‹",
      "é³³æ—å±±è¥¿åˆ€å‰Šéºµ","è¯æ–°ç‰›æ’","è€æ±Ÿç´…èŒ¶","å¤æ—©é­","ä¾¿ç•¶çˆºçˆº","è¶ŠéŒ¦é£Ÿå ‚","æ—å®¶æ¶¼éºµ",
      "è€é—†ä¸å¤ è¾£","ç«¹æ£§è¤‡åˆå¼","çœŸå¿ƒé£ŸåŠ","æ±æ¸¯é£¯æ¹¯","ä¸­åº„éºµé¤¨","åŒ—å¹³äº¬å»š","39 PIZZA",
      "ä»Šå¹´è²´ç¾¹","æ±Ÿé³¥ç´…","è˜‘è‡å’–å“©","ç±³ä¹‹è°·æµ·é®®æ¹¯é£¯","å¿«æ¨‚ç‰›æ’","ç„¡åä¾¿ç•¶","èµ¤å±±è‚‰åœ“",
      "å¤§å’–å’–å“©","ç¦åœ’é¤¡é¤…ç²¥","å¤ç³§ç¢³çƒ¤ä¸‰æ˜æ²»","å¤§å»Ÿå£é¹½æ°´é›","å¸ç‹ç‚’é£¯","èŠ±ä¹‹å£½å¸"
    ];

    /***************
     * 2) Firebase
     ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyCF5pYecoUpZuUWrVt6XsPaY1pEUj6SAQQ",
      authDomain: "banto-game-1af51.firebaseapp.com",
      databaseURL: "https://banto-game-1af51-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "banto-game-1af51",
      storageBucket: "banto-game-1af51.firebasestorage.app",
      messagingSenderId: "927905075193",
      appId: "1:927905075193:web:0ecff1815f990bbf01b728",
      measurementId: "G-DSM6S2E324"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, "bentoGame");

    /***************
     * 3) Google Apps Script
     ***************/
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyhiX0NkulmssuqddIRzFaHs8qtkp2m6p-Z8P9YMwCqUYt4E__cf7tSuuJiH-8TgrqwGw/exec";

    /***************
     * 4) UI åˆå§‹åŒ–
     ***************/
    const grid = document.getElementById("grid");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const bgm = document.getElementById("bgm");

    let state = { running: false, active: -1, chosen: null, done: [] };
    let timer = null;

    RESTAURANTS.forEach((name, i) => {
      const div = document.createElement("div");
      div.className = "cell";
      div.textContent = name;
      div.id = "cell-" + i;
      grid.appendChild(div);
    });

    function render(s) {
      RESTAURANTS.forEach((_, i) => {
        const cell = document.getElementById("cell-" + i);
        cell.className = "cell";
        if (s.done.includes(i)) cell.classList.add("done");
        if (s.active === i) cell.classList.add("active");
        if (s.chosen === i) cell.classList.add("chosen");
      });
    }

    /***************
     * 5) æŒ‰éˆ•äº‹ä»¶
     ***************/
    startBtn.onclick = async () => {
      if (state.running) return;
      bgm.play().catch(e => console.log("éŸ³æ¨‚æ’­æ”¾è¢«é˜»æ“‹:", e));

      let available = RESTAURANTS.map((_,i)=>i).filter(i=>!state.done.includes(i));
      if (available.length === 0) {
        state.done = [];
        available = RESTAURANTS.map((_,i)=>i);
      }

      timer = setInterval(() => {
        const idx = available[Math.floor(Math.random()*available.length)];
        state.active = idx; // æœ¬åœ°æ›´æ–°
        update(gameRef, { running: true, active: idx, chosen: null });
      }, 100);

      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      clearInterval(timer);
      bgm.pause();

      const chosen = state.active;
      if (chosen === -1) return; // é˜²å‘†

      state.done.push(chosen);
      update(gameRef, { running: false, active: -1, chosen, done: state.done });
      startBtn.disabled = false;
      stopBtn.disabled = true;

      // å¯„ä¿¡
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({ chosen: RESTAURANTS[chosen] })
      }).catch(err => console.error("å¯„ä¿¡å¤±æ•—:", err));
    };

    /***************
     * 6) Firebase ç›£è½
     ***************/
    onValue(gameRef, (snap) => {
      const s = snap.val();
      if (!s) return;
      state = s;
      render(state);

      if (s.running && !timer) {
        bgm.play().catch(err => console.log("è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹:", err));
      }
    });

    // åˆå§‹åŒ–ç‹€æ…‹
    get(gameRef).then(snap => {
      if (!snap.exists()) {
        set(gameRef, state);
      } else {
        state = snap.val();
        render(state);
      }
    });
  </script>
</body>
</html>


